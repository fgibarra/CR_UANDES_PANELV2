<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:camel="http://camel.apache.org/schema/blueprint"
    xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
    xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf"
    xmlns:http-conf="http://cxf.apache.org/transports/http/configuration"
    xmlns:jaxrs="http://cxf.apache.org/blueprint/jaxrs"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 https://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd        http://camel.apache.org/schema/blueprint https://camel.apache.org/schema/blueprint/camel-blueprint-2.20.2.xsd">
    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
    <!-- CXF servers -->
    <jaxrs:server address="/ESB/panelv3/servicio/crearGrupos/"
        id="rsPanelServices" staticSubresourceResolution="true">
        <jaxrs:serviceBeans>
            <ref component-id="restService"/>
        </jaxrs:serviceBeans>
        <jaxrs:providers>
            <bean class="com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider"/>
        </jaxrs:providers>
    </jaxrs:server>
    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
    <!-- CXF clients -->
    <cxf:rsClient
        address="http://localhost:8180/apigraph/ESB/panelV3/azureServices/group/retrieve/{groupName}"
        id="rsRetrieveGrupo" loggingFeatureEnabled="true" serviceClass="cl.uandes.panelv3.servicio.crearGrupos.api.restclient.GrupoEndpoint">
        <cxf:headers>
            <entry key="Content-Type" value="application/json"/>
            <entry key="Accept" value="application/json"/>
        </cxf:headers>
        <cxf:providers>
            <bean class="com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider"/>
        </cxf:providers>
    </cxf:rsClient>
    <!-- __________________________________________________________________________________________________ -->
    <cxf:rsClient
        address="http://localhost:8180/apigraph/ESB/panelV3/azureServices/group/create"
        id="rsCreateGrupo" loggingFeatureEnabled="true" serviceClass="cl.uandes.panelv3.servicio.crearGrupos.api.restclient.GrupoEndpoint">
        <cxf:headers>
            <entry key="Content-Type" value="application/json"/>
            <entry key="Accept" value="application/json"/>
        </cxf:headers>
        <cxf:providers>
            <bean class="com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider"/>
        </cxf:providers>
    </cxf:rsClient>
    <!-- __________________________________________________________________________________________________ -->
    <cxf:rsClient
        address="http://localhost:8180/apigraph/ESB/panelV3/azureServices/group/delete"
        id="rsDeleteGrupo" loggingFeatureEnabled="true" serviceClass="cl.uandes.panelv3.servicio.crearGrupos.api.restclient.GrupoEndpoint">
        <cxf:headers>
            <entry key="Content-Type" value="application/json"/>
            <entry key="Accept" value="application/json"/>
        </cxf:headers>
        <cxf:providers>
            <bean class="com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider"/>
        </cxf:providers>
    </cxf:rsClient>
    <!-- __________________________________________________________________________________________________ -->
    <cxf:rsClient
        address="http://localhost:8180/apigraph/ESB/panelV3/azureServices/member/addMember"
        id="rsAgregarMember" loggingFeatureEnabled="true" serviceClass="cl.uandes.panelv3.servicio.crearGrupos.api.restclient.GrupoEndpoint">
        <cxf:headers>
            <entry key="Content-Type" value="application/json"/>
            <entry key="Accept" value="application/json"/>
        </cxf:headers>
        <cxf:providers>
            <bean class="com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider"/>
        </cxf:providers>
    </cxf:rsClient>
    <!-- __________________________________________________________________________________________________ -->
    <cxf:rsClient
        address="http://localhost:8180/apigraph/ESB/panelV3/azureServices/member/deleteMember"
        id="rsSacarMember" loggingFeatureEnabled="true" serviceClass="cl.uandes.panelv3.servicio.crearGrupos.api.restclient.GrupoEndpoint">
        <cxf:headers>
            <entry key="Content-Type" value="application/json"/>
            <entry key="Accept" value="application/json"/>
        </cxf:headers>
        <cxf:providers>
            <bean class="com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider"/>
        </cxf:providers>
    </cxf:rsClient>
    <!-- __________________________________________________________________________________________________ -->
    <cxf:rsClient
        address="http://localhost:8180/apigraph/ESB/panelV3/azureServices/idCuentaUsuario"
        id="rsConsultarIdCuenta" loggingFeatureEnabled="true" serviceClass="cl.uandes.panelv3.servicio.crearGrupos.api.restclient.GrupoEndpoint">
        <cxf:headers>
            <entry key="Content-Type" value="application/json"/>
            <entry key="Accept" value="application/json"/>
        </cxf:headers>
        <cxf:providers>
            <bean class="com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider"/>
        </cxf:providers>
    </cxf:rsClient>
    <!-- __________________________________________________________________________________________________ -->
    <cxf:rsClient
        address="http://localhost:8181/cxf/ESB/panel/servicio/schedulerPanel"
        id="rsFinProceso" loggingFeatureEnabled="true" serviceClass="cl.uandes.panelv3.servicio.crearGrupos.api.restclient.SchedulerEndpoint">
        <cxf:headers>
            <entry key="Content-Type" value="application/json"/>
            <entry key="Accept" value="application/json"/>
        </cxf:headers>
        <cxf:providers>
            <bean class="com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider"/>
        </cxf:providers>
    </cxf:rsClient>
    <!-- __________________________________________________________________________________________________ -->
    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
    <bean
        class="cl.uandes.panelv3.servicio.crearGrupos.api.resources.CrearGruposRestService" id="restService">
        <property name="funcion" value="{{crear-grupos-azure.nocturno.funcion}}"/>
        <property name="proceso" value="{{crear-grupos-azure.proceso}}"/>
    </bean>
    <bean
        class="cl.uandes.panelv3.servicio.crearGrupos.procesor.InicialiceCrearGrupos" id="inicialiceCrearGrupos"/>
    <bean
        class="cl.uandes.panelv3.servicio.crearGrupos.procesor.GruposThread" id="gruposThread">
        <property name="azureServices" value="{{crear-grupos-azure.uri-azureServices}}"/>
        <property name="dominio" value="{{panelv3.dominio}}"/>
    </bean>
    <bean
        class="cl.uandes.panelv3.servicio.crearGrupos.procesor.InicialiceCrearGruposVigentes" id="inicialiceCrearGruposVigentes"/>
    <bean
        class="cl.uandes.panelv3.servicio.crearGrupos.procesor.GruposVigentesThread" id="gruposVigentesThread"/>
    <bean
        class="cl.uandes.panelv3.servicio.crearGrupos.procesor.InicialiceCrearGruposVigentesPosgrado" id="inicialiceCrearGruposVigentesPosgrado"/>
    <bean
        class="cl.uandes.panelv3.servicio.crearGrupos.procesor.GruposVigentesPosgradoThread" id="gruposVigentesPosgradoThread"/>
    <bean
        class="cl.uandes.panelv3.servicio.crearGrupos.procesor.GruposSinMiembrosThread" id="gruposSinMiembros">
        <property name="azureServices" value="{{crear-grupos-azure.uri-azureServices}}"/>
        <property name="delegate" ref="gruposThread"/>
    </bean>
    <bean
        class="cl.uandes.panelv3.servicio.crearGrupos.bean.GeneraDatos" id="generaDatos"/>
    <bean
        class="cl.uandes.panelv3.servicio.crearGrupos.procesor.ActualizaMiResultados" id="actualizaMiResultados">
        <property name="panelServices" value="{{crear-grupos-azure.uri-serviciosPanel}}"/>
    </bean>
    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
    <!-- ==================================================================================================== -->
    <reference availability="mandatory"
        filter="(osgi.jndi.service.name=bannerds)" id="bannerDataSource" interface="javax.sql.DataSource"/>
    <!-- ==================================================================================================== -->
    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
    <camelContext id="crear-grupos-azure" trace="false" xmlns="http://camel.apache.org/schema/blueprint">
        <propertyPlaceholder id="properties" location="file:${karaf.home}/etc/cl.uandes.panelv3.cfg"/>
        <!-- -->
        <route id="_readjson">
            <from id="_promService" uri="direct:start"/>
            <log id="_log2" message="(L143)queda en el body: ${body}"/>
            <to id="_to1" uri="direct:proceso"/>
        </route>
        <!--
        <route id="_fromInicio">
            <from id="_partida" uri="timer://foo?repeatCount=1"/>
            <bean id="_bean1" method="setBody" ref="generaDatos"/>
            <log id="_log3" message="(L150)queda en el body: ${body}"/>
            <to id="_to7" uri="direct:proceso"/>
        </route>
-->
        <!-- ================================================================================================= -->
        <!-- El pre proceso del requerimiento que viene desde el request	-->
        <!-- ================================================================================================= -->
        <route id="_procesoRoute">
            <from id="_proceso" uri="direct:proceso"/>
            <log id="_log6" message="(L159)En ruta _procesoRoute header.listaOperaciones.size: ${header.listaOperaciones.size}"/>
            <loop doWhile="true" id="_loop1">
                <simple>${header.listaOperaciones.size} &gt; 0</simple>
                <!--
				- inicializar proceso en funcion de la tabla KCO_FUNCIONES
				- invocar store-procedure que genera los grupos (crear) y miembros a agregar/eliminar
				- interactuar con azure para crear grupos y agregar/eliminar miembros
				- generar el resultado
				-->
                <bean id="_bean2" method="getListaOperaciones" ref="generaDatos"/>
                <log id="_log4" message="(L169)procesar ${header.proceso}"/>
                <log id="_log8" message="(L170)sql:select key, funcion, min_thread, max_thread, parametro, comentario, ultima_ejecucion from kco_funciones where funcion=${header.proceso}"/>
                <to id="_to4" uri="sql:classpath:sql/getKcoFuncion.sql?dataSource=#bannerDataSource"/>
                <process id="_recuperaDatosInicializar" ref="inicialiceCrearGrupos"/>
                <log id="_log15" message="(L173)despues de _recuperaDatosInicializar: DatosKcoFunciones_${header.DatosKcoFunciones} ResultadoFuncion: ${header.ResultadoFuncion} key: ${header.key}"/>
                <choice id="_choice1">
                    <when id="_when1">
                        <simple>${header.proceso} == 'crear_grupos_azure'</simple>
                        <setHeader headerName="emailPermission" id="_setHeader2">
                            <constant>Anyone</constant>
                        </setHeader>
                        <log id="_log9" message="(L180)values funcion ${header.proceso} (${header.DatosKcoFunciones.periodo}, ${header.emailPermission}, ${header.key})"/>
                        <to id="_to8" uri="sql-stored:classpath:sql/prd_puebla_mailgroupmembers.sql?dataSource=#bannerDataSource"/>
                        <to id="_to9" uri="direct:crearGrupos"/>
                    </when>
                    <when id="_when2">
                        <simple>${header.proceso} == 'grupos_inprogress_azure'</simple>
                        <setHeader headerName="emailPermission" id="_setHeader3">
                            <constant>Owner</constant>
                        </setHeader>
                        <log id="_log10" message="(L190)values funcion ${header.proceso} (${header.emailPermission}, ${header.key})"/>
                        <to id="_to10" uri="sql-stored:classpath:sql/prd_puebla_inprogressgroup.sql?dataSource=#bannerDataSource"/>
                        <to id="_to2" uri="direct:crearGruposVigentes"/>
                    </when>
                    <when id="_when3">
                        <simple>${header.proceso} == 'grupos_inprogress_posgrado_azure'</simple>
                        <setHeader headerName="emailPermission" id="_setHeader4">
                            <constant>Owner</constant>
                        </setHeader>
                        <log id="_log11" message="(L200)values funcion ${header.proceso} (${header.emailPermission}, ${header.key})"/>
                        <to id="_to11" uri="sql-stored:classpath:sql/prd_puebla_inprogresspostgrado.sql?dataSource=#bannerDataSource"/>
                        <to id="_to3" uri="direct:crearGruposVigentesPosgrado"/>
                    </when>
                    <otherwise id="_otherwise1">
                        <log id="_log5" message="(L206)Operacion desconocida"/>
                        <bean id="_bean3"
                            method="setOperacionDesconocida" ref="restService"/>
                    </otherwise>
                </choice>
            </loop>
        </route>
        <!-- ================================================================================================= -->
        <!--  El proceso de los distintos tipos de grupos -->
        <!-- ================================================================================================= -->
        <!--                               direct:crearGrupos                                                  -->
        <!-- ================================================================================================= -->
        <route id="_crearGrupos">
            <from id="_crearGruposRoute" uri="direct:crearGrupos"/>
            <!-- recuperar los grupos a procesar -->
            <log id="_log1" message="(L220) proceso:${header.proceso} recuperar los grupos a procesar: sql:classpath:sql/getGruposRegulares.sql"/>
            <to id="_to12" uri="sql:classpath:sql/getGruposRegulares.sql?dataSource=#bannerDataSource"/>
            <bean id="_bean4" method="factoryGrupos" ref="generaDatos"/>
            <to id="_to13" uri="direct:procesaGrupos"/>
            <to id="_eliminarGruposSinMiembros1" uri="direct:eliminarGruposSinMiembros"/>
            <to id="_to7" uri="direct:termina"/>
        </route>
        <!-- ================================================================================================= -->
        <!--                               direct:crearGruposVigentes                                          -->
        <!-- ================================================================================================= -->
        <route id="_crearGruposVigentes">
            <from id="_crearGruposVigentesRoute" uri="direct:crearGruposVigentes"/>
            <log id="_log3" message="(L229) proceso:${header.proceso} recuperar los grupos a procesar: sql:classpath:sql/getGruposVigentes.sql"/>
            <to id="_to14" uri="sql:classpath:sql/getGruposVigentes.sql?dataSource=#bannerDataSource"/>
            <bean id="_bean5" method="factoryGrupos" ref="generaDatos"/>
            <to id="_to15" uri="direct:procesaGrupos"/>
            <process id="_process4" ref="gruposVigentesThread"/>
            <to id="_eliminarGruposSinMiembros2" uri="direct:eliminarGruposSinMiembros"/>
            <to id="_to19" uri="direct:termina"/>
        </route>
        <!-- ================================================================================================= -->
        <!--                               direct:crearGruposVigentesPosgrado                                  -->
        <!-- ================================================================================================= -->
        <route id="_crearGruposVigentesPosgrado">
            <from id="_crearGruposVigentesPosgradoRoute" uri="direct:crearGruposVigentesPosgrado"/>
            <log id="_log17" message="(L239) proceso:${header.proceso} recuperar los grupos a procesar: sql:classpath:sql/getGruposPosgrado.sql"/>
            <to id="_to16" uri="sql:classpath:sql/getGruposPosgrado.sql?dataSource=#bannerDataSource"/>
            <bean id="_bean6" method="factoryGrupos" ref="generaDatos"/>
            <to id="_to17" uri="direct:procesaGrupos"/>
            <process id="_process6" ref="gruposVigentesPosgradoThread"/>
            <to id="_eliminarGruposSinMiembros3" uri="direct:eliminarGruposSinMiembros"/>
            <to id="_to20" uri="direct:termina"/>
        </route>
        <!-- ================================================================================================= -->
        <!--                               direct:eliminarGruposSinMiembros                                    -->
        <!-- ================================================================================================= -->
        <route id="_eliminarGruposSinMiembrosRoute">
            <from id="_from3" uri="direct:eliminarGruposSinMiembros"/>
            <log id="_log18" message="(L262)eliminar members no activos y no creados: sql/deleteNoActivosNocreados.sql"/>
            <to id="_to21" uri="sql:classpath:sql/deleteNap-0-0.sql"/>
            <log id="_log18" message="(L244)eliminarGruposSinMiembros: sql/getGruposSinMiembros.sql"/>
            <to id="_to18" uri="sql:classpath:sql/getGruposSinMiembros.sql?dataSource=#bannerDataSource"/>
            <bean id="_bean13" method="factoryGrupos" ref="generaDatos"/>
            <process id="_process1" ref="gruposSinMiembros"/>
        </route>
        <!-- ================================================================================================= -->
        <!--                               direct:termina                                                      -->
        <!-- ================================================================================================= -->
        <route id="_route1">
            <from id="_from4" uri="direct:termina"/>
            <log id="_log19" message="(L251)avisa termino proceso:${header.proceso} y hay en el body: ${body}"/>
            <process id="_process3" ref="actualizaMiResultados"/>
            <to id="_final" uri="mock:end"/>
        </route>
        <!-- ================================================================================================= -->
        <!--  Actions usados por los process -->
        <!-- ================================================================================================= -->
        <!--                               direct:getKey                                                       -->
        <!-- ================================================================================================= -->
        <route id="_getKey">
            <from id="_procesoInicialiceCrearGrupos1" uri="direct:getKey"/>
            <log id="_log12" message="(L252)antes del sequence"/>
            <to id="_to5" uri="sql:select HIBERNATE_SEQUENCE.nextval from dual?dataSource=#bannerDataSource"/>
            <log id="_log7" message="(L254)despues del sql: ${body}"/>
            <setHeader headerName="BD_KEY" id="_setHeader1">
                <simple>${body.get(0)[NEXTVAL]}</simple>
            </setHeader>
        </route>
        <!-- ================================================================================================= -->
        <!--                               direct:creaResultado                                                -->
        <!-- ================================================================================================= -->
        <route id="_creaResult">
            <from id="_procesoInicialiceCrearGrupos2" uri="direct:creaResultado"/>
            <log id="_log13" message="(L261)creaResult: values (${header.key},${header.funcion},${header.horaComienzo},${header.minThreads},${header.maxThreads}) "/>
            <log id="_log14" message="(L262)creaResult: body: ${body} "/>
            <to id="_to6" uri="jdbc:bannerDataSource?useHeadersAsParameters=true"/>
        </route>
        <!-- ================================================================================================= -->
        <!--                               direct:procesaGrupos                                                -->
        <!-- ================================================================================================= -->
        <route id="_procesaGruposRoute">
            <from id="_procesaGruposAction" uri="direct:procesaGrupos"/>
            <log id="_log20" message="(L267) Entrando a direct:procesaGrupos para procesar ${header.listaGrupos.size} elementos"/>
            <loop doWhile="true" id="_loop2">
                <simple>${header.listaGrupos.size} &gt; 0</simple>
                <bean id="_bean7" method="getGrupoFromListaGrupos" ref="generaDatos"/>
                <log id="_log16" message="(L268)el grupo a proicesar: ${header.grupoAzure}"/>
                <process id="_process2" ref="gruposThread"/>
            </loop>
        </route>
        <!-- ================================================================================================= -->
        <!--      PARA PRUEBAS OFFLINE -->
        <!-- ================================================================================================= -->
        <route id="_testCreateGrupoAzureRoute">
            <from id="_from1" uri="direct:testCreateGrupoAzure"/>
            <bean id="_bean8" method="testCreateGrupoAzure" ref="generaDatos"/>
        </route>
        <route id="_testRecuperaGrupoAzureRoute">
            <from id="_from2" uri="direct:testRecuperaGrupoAzure"/>
            <bean id="_bean9" method="testRecuperaGrupoAzure" ref="generaDatos"/>
        </route>
        <route id="_testtestSacarMemberRoute">
            <from id="_from2" uri="direct:testSacarMember"/>
            <bean id="_bean10" method="testSacarMember" ref="generaDatos"/>
        </route>
        <route id="_testtestAgregarMemberRoute">
            <from id="_from2" uri="direct:testAgregarMember"/>
            <bean id="_bean11" method="testAgregarMember" ref="generaDatos"/>
        </route>
        <route id="_testtestDeleteGrupoAzureRoute">
            <from id="_from2" uri="direct:testDeleteGrupoAzure"/>
            <bean id="_bean12" method="testDeleteGrupoAzure" ref="generaDatos"/>
        </route>
    </camelContext>
</blueprint>
